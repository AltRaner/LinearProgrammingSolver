<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MainMenu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
        }

        function updateTables() {
            const constraintsCount = document.getElementById('constraints-count').value;
            const constraintsTable = document.getElementById('constraints-table');
            constraintsTable.innerHTML = '';

            for (let i = 0; i < constraintsCount; i++) {
                constraintsTable.innerHTML += `<tr>
                    <td><input type='number' class='form-control' placeholder='x1'></td>
                    <td><input type='number' class='form-control' placeholder='x2'></td>
                    <td>
                        <select class='form-control'>
                            <option value='<='>≤</option>
                            <option value='>='>≥</option>
                        </select>
                    </td>
                    <td><input type='number' class='form-control' placeholder='B'></td>
                </tr>`;
            }
        }

        function findIntersection(line1, line2) {
            let { a: a1, b: b1, c: c1 } = line1;
            let { a: a2, b: b2, c: c2 } = line2;
            let det = a1 * b2 - a2 * b1;
            if (det === 0) return null; 
            let x = (c1 * b2 - c2 * b1) / det;
            let y = (a1 * c2 - a2 * c1) / det;
            return { x, y };
        }

        function solveGraphicalMethod() {
    const inputs = document.querySelectorAll('#objective-function input');
    const x1 = parseFloat(inputs[0].value);
    const x2 = parseFloat(inputs[1].value);

    if (isNaN(x1) || isNaN(x2)) {
        document.getElementById('solution-output').innerHTML = "Ошибка: введите все коэффициенты целевой функции.";
        return;
    }

    const constraints = [];
    document.querySelectorAll('#constraints-table tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        const sign = row.querySelector('select').value;
        const a = parseFloat(inputs[0].value);
        const b = parseFloat(inputs[1].value);
        const c = parseFloat(inputs[2].value);
        if (!isNaN(a) && !isNaN(b) && !isNaN(c)) {
            constraints.push({ a, b, sign, c });
        }
    });

    let points = [];
    for (let i = 0; i < constraints.length; i++) {
        for (let j = i + 1; j < constraints.length; j++) {
            let intersection = findIntersection(constraints[i], constraints[j]);
            if (intersection) {
                points.push(intersection);
            }
        }
    }

    points = points.filter(p => constraints.every(c => {
        return c.sign === '<=' ? c.a * p.x + c.b * p.y <= c.c : c.a * p.x + c.b * p.y >= c.c;
    }));

    let bestPoint = null;
    let bestValue = document.getElementById('opt-goal').checked ? -Infinity : Infinity;

    points.forEach(p => {
        let value = x1 * p.x + x2 * p.y;
        if ((document.getElementById('opt-goal').checked && value > bestValue) || (!document.getElementById('opt-goal').checked && value < bestValue)) {
            bestValue = value;
            bestPoint = p;
        }
    });

    if (bestPoint) {
        document.getElementById('solution-output').innerHTML = `А = (${bestPoint.x.toFixed(2)}, ${bestPoint.y.toFixed(2)})<br>
            L = ${x1} * ${bestPoint.x.toFixed(2)} + ${x2} * ${bestPoint.y.toFixed(2)} = ${bestValue.toFixed(2)}`;

        drawGraph(constraints, bestPoint);
    } else {
        document.getElementById('solution-output').innerHTML = "Нет допустимого решения";
    }
}

function drawGraph(constraints, bestPoint) {
    const ctx = document.getElementById('graphCanvas').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: constraints.map((c, i) => ({
                label: `Ограничение ${i + 1}`,
                borderColor: 'rgba(0, 0, 255, 0.5)',
                showLine: true,
                data: [{ x: 0, y: c.c / c.b }, { x: c.c / c.a, y: 0 }]
            })).concat({
                label: 'Оптимальная точка',
                data: [{ x: bestPoint.x, y: bestPoint.y }],
                backgroundColor: 'red',
                pointRadius: 5
            })
        },
        options: {
            scales: {
                x: { type: 'linear', position: 'bottom' },
                y: { type: 'linear' }
            }
        }
    });
}

 function updateSimplexTables() {
            const variablesCount = document.getElementById('variables-count').value;
            const constraintsCount = document.getElementById('simplex-constraints-count').value;
            const simplexTable = document.getElementById('simplex-constraints-table');
            const objectiveTable = document.getElementById('simplex-objective-function');

            simplexTable.innerHTML = '';
            objectiveTable.innerHTML = '';

            // Обновление таблицы целевой функции
            let objRow = `<tr>`;
            for (let j = 0; j < variablesCount; j++) {
                objRow += `<td><input type='number' class='form-control' placeholder='x${j + 1}'></td>`;
            }
            objRow += `</tr>`;
            objectiveTable.innerHTML = objRow;

            // Обновление таблицы ограничений
            for (let i = 0; i < constraintsCount; i++) {
                let row = `<tr>`;
                for (let j = 0; j < variablesCount; j++) {
                    row += `<td><input type='number' class='form-control' placeholder='x${j + 1}'></td>`;
                }
                row += `
                    <td>
                        <select class='form-control'>
                            <option value="<=">≤</option>
                            <option value=">=">≥</option>
                        </select>
                    </td>
                    <td><input type='number' class='form-control' placeholder='B'></td>
                </tr>`;
                simplexTable.innerHTML += row;
            }
        }

function solveSimplexMethod() {
    let variablesCount = parseInt(document.getElementById('variables-count').value);
    let constraintsCount = parseInt(document.getElementById('simplex-constraints-count').value);
    let maximize = document.getElementById('simplex-opt-goal')?.checked ?? false;

    let objCoefficients = [];
    let constraints = [];

    // Сбор данных о целевой функции
    document.querySelectorAll('#simplex-objective-function input').forEach(input => {
        objCoefficients.push(parseFloat(input.value) || 0);
    });

    // Сбор данных об ограничениях
    document.querySelectorAll('#simplex-constraints-table tr').forEach(row => {
        let inputs = row.querySelectorAll('input');
        let sign = row.querySelector('select')?.value || "<=";
        let constraint = [];

        for (let j = 0; j < variablesCount; j++) {
            constraint.push(parseFloat(inputs[j]?.value) || 0);
        }

        let b = parseFloat(inputs[variablesCount]?.value) || 0;
        constraints.push({ coeffs: constraint, sign, b });
    });

    console.log("Целевая функция:", objCoefficients);
    console.log("Ограничения:", constraints);

    // Применяем симплекс-метод для решения задачи
    let result = simplexMethod(objCoefficients, constraints, maximize);

    // Отображение результата
    displayFinalSolution(result);
}

// Симплекс-метод для решения задачи
function simplexMethod(c, constraints, maximize) {
    let m = constraints.length;
    let n = c.length;
    let table = [];

    // Строим начальную симплекс-таблицу
    for (let i = 0; i < m; i++) {
        let row = constraints[i].coeffs.concat([constraints[i].b]);
        table.push(row);
    }

    let objRow = c.concat([0]);
    table.push(objRow);

    let solution = Array(n).fill(0); // начальное решение
    let iterations = 0;
    let isOptimal = false;
    let iterationResults = []; // Сюда будем сохранять все таблицы

    // Итерации симплекс-метода
    while (!isOptimal && iterations < 100) {
        // Сохраняем текущую таблицу
        iterationResults.push(cloneTable(table));

        // Поиск минимального элемента в строке целевой функции
        let pivotCol = -1;
        let minVal = maximize ? Math.min(...table[m]) : Math.max(...table[m]);

        if (minVal >= 0 && !maximize || minVal <= 0 && maximize) {
            isOptimal = true; // если нет отрицательных элементов, решение оптимально
        } else {
            pivotCol = table[m].indexOf(minVal);

            // Находим строку для разворота
            let ratios = [];
            for (let i = 0; i < m; i++) {
                if (table[i][pivotCol] > 0) {
                    ratios.push(table[i][n] / table[i][pivotCol]);
                } else {
                    ratios.push(Infinity);
                }
            }

            let pivotRow = ratios.indexOf(Math.min(...ratios));

            // Проводим разворот
            let pivotValue = table[pivotRow][pivotCol];
            for (let j = 0; j <= n; j++) {
                table[pivotRow][j] /= pivotValue;
            }

            // Обновление других строк
            for (let i = 0; i <= m; i++) {
                if (i !== pivotRow) {
                    let ratio = table[i][pivotCol];
                    for (let j = 0; j <= n; j++) {
                        table[i][j] -= ratio * table[pivotRow][j];
                    }
                }
            }
        }
        iterations++;
    }

    // Сохраняем последнюю таблицу (финальную)
    iterationResults.push(cloneTable(table));

    // Извлекаем решение из симплекс-таблицы
    for (let i = 0; i < n; i++) {
        solution[i] = table[m][i];
    }

    return { solution, optimalValue: table[m][n], iterationResults };
}

// Клонирование таблицы для сохранения состояния в каждой итерации
function cloneTable(table) {
    return table.map(row => [...row]);
}

// Функция для отображения решения и каждой итерации
function displayFinalSolution(result) {
    let output = document.getElementById('solution-output-simplex');
    output.innerHTML = '';

    if (!result) {
        output.innerHTML = '<p class="text-danger">Ошибка: нет допустимого решения</p>';
        return;
    }

    // Выводим решение для всех переменных
    let solutionText = result.solution.map((val, i) => `x${i + 1} = ${val.toFixed(2)}`).join(' ');
    output.innerHTML = `<p class="text-success">Оптимальное решение:<br>${solutionText}<br>Z = ${result.optimalValue.toFixed(2)}</p>`;

    // Отображаем таблицы каждой итерации
    let iterationDiv = document.createElement('div');
    iterationDiv.innerHTML = `<h4>Решение шаг за шагом:</h4>`;
    result.iterationResults.forEach((iterationTable, index) => {
        let tableHtml = `<h5>Итерация ${index + 1}:</h5><table class="table">`;
        iterationTable.forEach(row => {
            tableHtml += `<tr>${row.map(cell => `<td>${cell.toFixed(2)}</td>`).join('')}</tr>`;
        });
        tableHtml += '</table>';
        iterationDiv.innerHTML += tableHtml;
    });
    output.appendChild(iterationDiv);
}

    </script>
</head>
<body class="container mt-4">
    <h1 class="text-center">Решение задач линейного программирования</h1>
    
    <nav class="nav nav-pills justify-content-center my-3">
        <button class="nav-link" onclick="showSection('graphic-method')">Графический метод</button>
        <button class="nav-link" onclick="showSection('simplex-method')">Симплекс-метод</button>
        <button class="nav-link" onclick="showSection('transport-problem')">Транспортная задача</button>
    </nav>
    
    <div id="graphic-method" class="content-section" style="display: none;">
        <h2>Графический метод</h2>
        <label for="constraints-count">Количество ограничений:</label>
        <input type="number" id="constraints-count" class="form-control" min="1" value="2">
        <button class="btn btn-primary mt-2" onclick="updateTables()">Обновить таблицы</button>

        <h3>Коэффициенты целевой функции:</h3>
        <table class="table" id="objective-function">
            <tr>
                <td><input type="number" class="form-control" placeholder="x1"></td>
                <td><input type="number" class="form-control" placeholder="x2"></td>
            </tr>
        </table>

        <label>Min <input type="checkbox" id="opt-goal"> Max</label>

        <h3>Коэффициенты ограничений:</h3>
        <table class="table" id="constraints-table"></table>

        <button class="btn btn-success mt-3" onclick="solveGraphicalMethod()">Решить</button>

        <h3>Результат:</h3>
	<canvas id="graphCanvas" width="200" height="200"></canvas>
        <p id="solution-output"></p>
    </div>

    <div id="simplex-method" class="content-section" style="display: block;">
        <h2 class="mb-4">Симплекс-метод</h2>
        <div class="form-group">
            <label for="variables-count">Количество переменных:</label>
            <input type="number" id="variables-count" class="form-control" min="1" value="2" onchange="updateSimplexTables()">
        </div>

        <div class="form-group">
            <label for="simplex-constraints-count">Количество ограничений:</label>
            <input type="number" id="simplex-constraints-count" class="form-control" min="1" value="2" onchange="updateSimplexTables()">
        </div>

        <button class="btn btn-primary mt-2" onclick="updateSimplexTables()">Обновить таблицы</button>

        <h3 class="mt-4">Целевая функция:</h3>
        <table class="table" id="simplex-objective-function">
            <thead>
                <tr>
                    <th scope="col">x1</th>
                    <th scope="col">x2</th>
                    <th scope="col">...</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="number" class="form-control" placeholder="x1" value="1"></td>
                    <td><input type="number" class="form-control" placeholder="x2" value="1"></td>
                    <td><input type="number" class="form-control" placeholder="x3" value="0"></td>
                </tr>
            </tbody>
        </table>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="simplex-opt-goal">
            <label class="form-check-label" for="simplex-opt-goal">
                Максимизировать
            </label>
        </div>

        <h3 class="mt-4">Коэффициенты ограничений:</h3>
        <table class="table" id="simplex-constraints-table"></table>

        <button class="btn btn-success mt-3" onclick="solveSimplexMethod()">Решить</button>

        <h3 class="mt-4">Результат:</h3>
        <div id="solution-output-simplex" class="mt-3"></div>
    </div>

<!-- Стиль -->
<style>
    .content-section {
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    h2 {
        font-size: 24px;
        color: #007bff;
    }

    h3 {
        font-size: 20px;
        color: #333;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
    }

    .btn {
        font-size: 16px;
    }

    .table {
        width: 100%;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .table th, .table td {
        padding: 10px;
        text-align: center;
    }

    .table input {
        width: 70px;
    }

    .form-check-label {
        margin-left: 10px;
    }

    #solution-output-simplex {
        font-size: 16px;
        color: #333;
    }
</style>

</body>
</html>
